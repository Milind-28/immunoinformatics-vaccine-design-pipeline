"""
Custom VBA To Further Clean Data for finding Strong and Weak Binder from the results in excel based on dummy thresholds.
"""
Sub SummarizeBinders()
    Dim inputSheetName As String, outputSheetName As String
    Dim wsRaw As Worksheet, wsSummary As Worksheet
    Dim dict As Object
    Dim lastRow As Long, i As Long
    Dim peptide As String, allele As String
    Dim prediction As Double
    Dim key As Variant
    Dim entry As Variant

    ' Prompt user for input and output sheet names
    inputSheetName = InputBox("Enter the name of the input sheet:", "Specify Input Sheet", "RawData")
    If inputSheetName = "" Then Exit Sub ' Exit if canceled or blank

    outputSheetName = InputBox("Enter the name of the output sheet:", "Specify Output Sheet", "Summary")
    If outputSheetName = "" Then Exit Sub ' Exit if canceled or blank

    ' Set input worksheet
    On Error Resume Next
    Set wsRaw = ThisWorkbook.Sheets(inputSheetName)
    On Error GoTo 0

    If wsRaw Is Nothing Then
        MsgBox "Input sheet '" & inputSheetName & "' not found! Check the sheet name.", vbCritical
        Exit Sub
    End If

    ' Delete existing output sheet, if any
    On Error Resume Next
    Application.DisplayAlerts = False
    Worksheets(outputSheetName).Delete
    Application.DisplayAlerts = True
    On Error GoTo 0

    ' Create output sheet
    Set wsSummary = ThisWorkbook.Sheets.Add
    wsSummary.Name = outputSheetName

    ' Create dictionary to store peptide-wise data
    Set dict = CreateObject("Scripting.Dictionary")

    ' Get last row in the input sheet
    lastRow = wsRaw.Cells(wsRaw.Rows.Count, "A").End(xlUp).Row

    ' Loop through the data
    For i = 2 To lastRow
        peptide = wsRaw.Cells(i, "B").Value
        allele = wsRaw.Cells(i, "A").Value
        prediction = wsRaw.Cells(i, "C").Value

        If Not dict.exists(peptide) Then
            Set dict(peptide) = CreateObject("Scripting.Dictionary")
            dict(peptide)("StrongCount") = 0
            dict(peptide)("WeakCount") = 0
            Set dict(peptide)("StrongAlleles") = CreateObject("Scripting.Dictionary")
        End If

        If prediction < 50 Then
            dict(peptide)("StrongCount") = dict(peptide)("StrongCount") + 1
            dict(peptide)("StrongAlleles")(allele) = True
        ElseIf prediction < 500 Then
            dict(peptide)("WeakCount") = dict(peptide)("WeakCount") + 1
        End If
    Next i

    ' Write headers to the output sheet
    wsSummary.Cells(1, 1).Value = "Peptide"
    wsSummary.Cells(1, 2).Value = "Weak Bindings"
    wsSummary.Cells(1, 3).Value = "Strong Bindings"
    wsSummary.Cells(1, 4).Value = "Strong Binding Alleles"

    Dim rowNum As Long: rowNum = 2
    For Each key In dict.Keys
        wsSummary.Cells(rowNum, 1).Value = key
        wsSummary.Cells(rowNum, 2).Value = dict(key)("WeakCount")
        wsSummary.Cells(rowNum, 3).Value = dict(key)("StrongCount")

        ' Concatenate strong alleles
        Dim alleleList As String: alleleList = ""
        For Each entry In dict(key)("StrongAlleles").Keys
            alleleList = alleleList & entry & ", "
        Next

        ' Trim trailing comma
        If Len(alleleList) > 2 Then
            alleleList = Left(alleleList, Len(alleleList) - 2)
        End If

        wsSummary.Cells(rowNum, 4).Value = alleleList

        rowNum = rowNum + 1
    Next key

    wsSummary.Columns.AutoFit
    MsgBox "Summary table created successfully!", vbInformation
End Sub

